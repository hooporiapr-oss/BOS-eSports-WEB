<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>CLUTCH TIMER | BOS Esports ‚Äî Neurocognitive Training</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
/*‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê*/
/*  CLUTCH TIMER ‚Äî BOS ESPORTS DESIGN SYSTEM               */
/*  Decision Quality Under Cognitive Load                    */
/*‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê*/
:root {
    --dark: #0a0a0f;
    --darker: #050508;
    --card: #111118;
    --card-hover: #18181f;
    --gold: #FFD700;
    --orange: #FF6B35;
    --teal: #00D9A5;
    --cyan: #00E5FF;
    --red: #FF3B5C;
    --purple: #9D4EDD;
    --text: #FFFFFF;
    --muted: #6b7280;
    --muted-light: #9ca3af;
    --border: rgba(255,255,255,0.06);
    --glow-gold: rgba(255,215,0,0.15);
    --glow-orange: rgba(255,107,53,0.15);
    --glow-teal: rgba(0,217,165,0.15);
    --glow-red: rgba(255,59,92,0.15);
    --radius: 20px;
    --radius-sm: 12px;
    --radius-xs: 8px;
    /* Tier Colors */
    --bronze: #CD7F32;
    --silver: #C0C0C0;
    --gold-tier: #FFD700;
    --diamond: #B9F2FF;
    --radiant: #FF6B35;
}
* { margin:0; padding:0; box-sizing:border-box; }
html, body {
    height: 100%; overflow: hidden;
    font-family: 'Outfit', sans-serif;
    background: var(--dark);
    color: var(--text);
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
    -webkit-user-select: none; user-select: none;
}

/* ‚ïê‚ïê‚ïê NOISE TEXTURE ‚ïê‚ïê‚ïê */
body::before {
    content: ''; position: fixed; inset: 0; z-index: 0; pointer-events: none;
    opacity: 0.03;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
}

/* ‚ïê‚ïê‚ïê BACK NAV ‚ïê‚ïê‚ïê */
.back-nav {
    position: fixed; top: 0; left: 0; right: 0; z-index: 100;
    height: 48px; display: flex; align-items: center; padding: 0 16px;
    background: rgba(10,10,15,0.92); backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
}
.back-btn {
    display: flex; align-items: center; gap: 6px;
    color: var(--muted-light); text-decoration: none; font-size: 0.8rem; font-weight: 500;
    transition: color 0.2s;
}
.back-btn:hover { color: var(--gold); }
.back-btn svg { width: 16px; height: 16px; }
.nav-title {
    flex: 1; text-align: center;
    font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 2px;
    background: linear-gradient(135deg, var(--gold), var(--orange));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.nav-badge {
    font-size: 0.6rem; font-weight: 700; padding: 3px 8px;
    border-radius: 20px; letter-spacing: 0.5px;
}

/* ‚ïê‚ïê‚ïê MAIN CONTAINER ‚ïê‚ïê‚ïê */
.game-container {
    position: relative; z-index: 1;
    max-width: 500px; margin: 0 auto; padding: 56px 16px 16px;
    height: 100vh; height: 100dvh;
    display: flex; flex-direction: column; overflow: hidden;
}

/* ‚ïê‚ïê‚ïê TIER SELECT SCREEN ‚ïê‚ïê‚ïê */
.screen { display: none; flex-direction: column; flex: 1; }
.screen.active { display: flex; }

.tier-select { gap: 12px; padding-top: 8px; overflow-y: auto; }
.tier-header {
    text-align: center; margin-bottom: 4px;
}
.tier-header h1 {
    font-family: 'Bebas Neue', sans-serif; font-size: 2rem; letter-spacing: 3px;
    background: linear-gradient(135deg, var(--gold), var(--orange));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.tier-header p {
    font-size: 0.75rem; color: var(--muted-light); margin-top: 2px;
}

.tier-card {
    background: var(--card); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 14px 16px; cursor: pointer; transition: all 0.25s;
    display: flex; align-items: center; gap: 14px;
    position: relative; overflow: hidden;
}
.tier-card::before {
    content: ''; position: absolute; inset: 0; opacity: 0;
    transition: opacity 0.3s; pointer-events: none;
}
.tier-card:hover { border-color: rgba(255,215,0,0.3); transform: translateY(-1px); }
.tier-card:hover::before { opacity: 1; }
.tier-card.locked { opacity: 0.4; cursor: not-allowed; }
.tier-card.locked:hover { transform: none; border-color: var(--border); }

.tier-icon {
    width: 48px; height: 48px; border-radius: 14px;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.3rem; font-weight: 800; flex-shrink: 0;
    font-family: 'Bebas Neue', sans-serif; letter-spacing: 1px;
}
.tier-info { flex: 1; }
.tier-name {
    font-family: 'Bebas Neue', sans-serif; font-size: 1.15rem; letter-spacing: 1.5px;
}
.tier-desc { font-size: 0.7rem; color: var(--muted-light); margin-top: 2px; }
.tier-stats {
    display: flex; gap: 10px; margin-top: 6px;
}
.tier-stat {
    font-size: 0.6rem; color: var(--muted); display: flex; align-items: center; gap: 3px;
}
.tier-stat span { color: var(--gold); font-weight: 600; }
.tier-best {
    text-align: right; flex-shrink: 0;
}
.tier-best-label { font-size: 0.55rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
.tier-best-value { font-family: 'Bebas Neue', sans-serif; font-size: 1.3rem; color: var(--gold); }
.tier-lock { font-size: 1.2rem; flex-shrink: 0; }

/* Tier color themes */
.tier-bronze .tier-icon { background: rgba(205,127,50,0.15); color: var(--bronze); }
.tier-bronze::before { background: linear-gradient(135deg, rgba(205,127,50,0.05), transparent); }
.tier-silver .tier-icon { background: rgba(192,192,192,0.12); color: var(--silver); }
.tier-silver::before { background: linear-gradient(135deg, rgba(192,192,192,0.05), transparent); }
.tier-gold .tier-icon { background: rgba(255,215,0,0.12); color: var(--gold-tier); }
.tier-gold::before { background: linear-gradient(135deg, rgba(255,215,0,0.05), transparent); }
.tier-diamond .tier-icon { background: rgba(185,242,255,0.12); color: var(--diamond); }
.tier-diamond::before { background: linear-gradient(135deg, rgba(185,242,255,0.05), transparent); }
.tier-radiant .tier-icon { background: linear-gradient(135deg, rgba(255,107,53,0.2), rgba(255,215,0,0.15)); color: var(--radiant); }
.tier-radiant::before { background: linear-gradient(135deg, rgba(255,107,53,0.08), rgba(255,215,0,0.05)); }

/* ‚ïê‚ïê‚ïê GAME SCREEN ‚ïê‚ïê‚ïê */
.game-play { gap: 0; position: relative; }

/* HUD */
.hud {
    display: flex; justify-content: space-between; align-items: center;
    padding: 6px 0; flex-shrink: 0;
}
.hud-left, .hud-right { display: flex; align-items: center; gap: 12px; }
.hud-stat { text-align: center; }
.hud-stat-value {
    font-family: 'Bebas Neue', sans-serif; font-size: 1.4rem; line-height: 1;
}
.hud-stat-label { font-size: 0.55rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
.hud-score { color: var(--gold); }
.hud-streak { color: var(--orange); }
.hud-prompt-count { color: var(--teal); }
.hud-accuracy { color: var(--cyan); }

/* Active Rules Display */
.rules-bar {
    display: flex; align-items: center; justify-content: center; gap: 6px;
    padding: 6px 12px; margin: 4px 0;
    background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-xs);
    min-height: 32px; flex-shrink: 0;
    transition: all 0.3s;
}
.rules-bar.rule-change {
    animation: ruleFlash 0.6s ease;
}
@keyframes ruleFlash {
    0%, 100% { border-color: var(--border); }
    50% { border-color: var(--orange); box-shadow: 0 0 15px rgba(255,107,53,0.3); }
}
.rule-badge {
    font-size: 0.65rem; font-weight: 600; padding: 3px 10px;
    border-radius: 20px; letter-spacing: 0.3px;
    background: rgba(255,215,0,0.1); border: 1px solid rgba(255,215,0,0.25);
    color: var(--gold); white-space: nowrap;
    transition: all 0.3s;
}
.rule-badge.new {
    animation: badgePop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}
@keyframes badgePop {
    0% { transform: scale(0.7); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
}
.rule-badge.conflict {
    background: rgba(255,59,92,0.12); border-color: rgba(255,59,92,0.3); color: var(--red);
}

/* Decision Timer Bar */
.timer-bar-container {
    height: 6px; border-radius: 3px; background: rgba(255,255,255,0.06);
    margin: 6px 0; overflow: hidden; flex-shrink: 0;
    position: relative;
}
.timer-bar {
    height: 100%; border-radius: 3px;
    background: linear-gradient(90deg, var(--teal), var(--gold));
    transition: width 0.05s linear;
    position: relative;
}
.timer-bar.warning { background: linear-gradient(90deg, var(--orange), var(--red)); }
.timer-bar.critical { background: var(--red); animation: timerPulse 0.3s infinite; }
@keyframes timerPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

/* Decision Arena */
.arena {
    flex: 1; display: flex; align-items: center; justify-content: center;
    position: relative; min-height: 280px;
}
.arena-inner {
    position: relative; width: 100%; max-width: 360px; aspect-ratio: 1;
}

/* Central Prompt */
.prompt-card {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 110px; height: 110px; border-radius: var(--radius);
    background: var(--card); border: 2px solid var(--border);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    z-index: 10;
    transition: border-color 0.3s, box-shadow 0.3s;
}
.prompt-card.active {
    border-color: rgba(255,215,0,0.4);
    box-shadow: 0 0 30px rgba(255,215,0,0.1);
}
.prompt-symbol {
    font-size: 2.2rem; line-height: 1;
}
.prompt-label {
    font-size: 0.6rem; color: var(--muted); margin-top: 4px;
    text-transform: uppercase; letter-spacing: 0.5px;
}

/* Decision Zones */
.zone {
    position: absolute; width: 90px; height: 90px;
    border-radius: var(--radius); background: var(--card);
    border: 2px solid var(--border);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    cursor: pointer; transition: all 0.2s;
    z-index: 5;
}
.zone:hover { transform: scale(1.06); }
.zone:active { transform: scale(0.95); }
.zone.hidden { opacity: 0; pointer-events: none; }
.zone-symbol { font-size: 1.8rem; line-height: 1; }
.zone-label { font-size: 0.55rem; color: var(--muted); margin-top: 3px; letter-spacing: 0.3px; }

/* Zone positions */
.zone-top { top: 4%; left: 50%; transform: translateX(-50%); }
.zone-top:hover { transform: translateX(-50%) scale(1.06); }
.zone-top:active { transform: translateX(-50%) scale(0.95); }
.zone-right { top: 50%; right: 4%; transform: translateY(-50%); }
.zone-right:hover { transform: translateY(-50%) scale(1.06); }
.zone-right:active { transform: translateY(-50%) scale(0.95); }
.zone-bottom { bottom: 4%; left: 50%; transform: translateX(-50%); }
.zone-bottom:hover { transform: translateX(-50%) scale(1.06); }
.zone-bottom:active { transform: translateX(-50%) scale(0.95); }
.zone-left { top: 50%; left: 4%; transform: translateY(-50%); }
.zone-left:hover { transform: translateY(-50%) scale(1.06); }
.zone-left:active { transform: translateY(-50%) scale(0.95); }

/* Zone feedback states */
.zone.correct {
    border-color: var(--teal) !important; background: rgba(0,217,165,0.15) !important;
    box-shadow: 0 0 25px rgba(0,217,165,0.3);
    animation: zoneCorrect 0.5s ease;
}
@keyframes zoneCorrect {
    0% { transform: scale(1); }
    30% { transform: scale(1.1); }
    100% { transform: scale(1); }
}
.zone.wrong {
    border-color: var(--red) !important; background: rgba(255,59,92,0.15) !important;
    box-shadow: 0 0 25px rgba(255,59,92,0.3);
    animation: zoneWrong 0.4s ease;
}
@keyframes zoneWrong {
    0%, 100% { transform: scale(1); }
    25% { transform: translateX(-4px); }
    75% { transform: translateX(4px); }
}
.zone.reveal {
    border-color: var(--gold) !important; opacity: 0.6;
}
.zone.timeout-correct {
    border-color: var(--gold) !important; background: rgba(255,215,0,0.1) !important;
    animation: zonePulseGold 0.8s ease;
}
@keyframes zonePulseGold {
    0%, 100% { box-shadow: none; }
    50% { box-shadow: 0 0 20px rgba(255,215,0,0.3); }
}

/* Zone color fills for prompts */
.zone[data-color="red"] { border-color: rgba(255,59,92,0.4); }
.zone[data-color="red"] .zone-symbol { color: var(--red); }
.zone[data-color="blue"] { border-color: rgba(96,165,250,0.4); }
.zone[data-color="blue"] .zone-symbol { color: #60A5FA; }
.zone[data-color="green"] { border-color: rgba(0,217,165,0.4); }
.zone[data-color="green"] .zone-symbol { color: var(--teal); }
.zone[data-color="gold"] { border-color: rgba(255,215,0,0.4); }
.zone[data-color="gold"] .zone-symbol { color: var(--gold); }

/* Speed Bonus Popup */
.speed-popup {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    font-family: 'Bebas Neue', sans-serif; font-size: 1.4rem;
    pointer-events: none; z-index: 20; opacity: 0;
    text-shadow: 0 0 10px currentColor;
}
.speed-popup.show {
    animation: popUp 0.8s ease forwards;
}
@keyframes popUp {
    0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
    30% { opacity: 1; transform: translate(-50%, -70%) scale(1.1); }
    100% { opacity: 0; transform: translate(-50%, -120%) scale(0.8); }
}

/* ‚ïê‚ïê‚ïê FEEDBACK MESSAGE ‚ïê‚ïê‚ïê */
.feedback-bar {
    text-align: center; padding: 4px 0; min-height: 24px; flex-shrink: 0;
}
.feedback-text {
    font-size: 0.75rem; font-weight: 600; letter-spacing: 0.3px;
    transition: all 0.2s;
}
.feedback-text.correct { color: var(--teal); }
.feedback-text.wrong { color: var(--red); }
.feedback-text.timeout { color: var(--orange); }
.feedback-text.streak { color: var(--gold); }
.feedback-text.rule-change { color: var(--cyan); }

/* ‚ïê‚ïê‚ïê ACTION BUTTON ‚ïê‚ïê‚ïê */
.action-btn {
    width: 100%; padding: 14px; border: none; border-radius: var(--radius-sm);
    font-family: 'Bebas Neue', sans-serif; font-size: 1.3rem;
    letter-spacing: 3px; cursor: pointer; color: var(--dark);
    background: linear-gradient(135deg, var(--gold), var(--orange));
    transition: all 0.2s; flex-shrink: 0;
    position: relative; overflow: hidden;
}
.action-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 20px rgba(255,215,0,0.3); }
.action-btn:active { transform: translateY(0); }
.action-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

/* ‚ïê‚ïê‚ïê RESULTS SCREEN ‚ïê‚ïê‚ïê */
.results { gap: 12px; align-items: center; justify-content: center; padding-top: 10px; }
.results-tier {
    font-family: 'Bebas Neue', sans-serif; font-size: 0.85rem;
    letter-spacing: 2px; color: var(--muted-light);
}
.results-score {
    font-family: 'Bebas Neue', sans-serif; font-size: 4rem; line-height: 1;
    background: linear-gradient(135deg, var(--gold), var(--orange));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.results-label { font-size: 0.7rem; color: var(--muted); margin-top: -4px; }
.results-grid {
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;
    width: 100%; max-width: 320px;
}
.result-stat {
    background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-sm);
    padding: 10px 8px; text-align: center;
}
.result-stat-value {
    font-family: 'Bebas Neue', sans-serif; font-size: 1.4rem; line-height: 1;
}
.result-stat-label { font-size: 0.55rem; color: var(--muted); margin-top: 3px; text-transform: uppercase; }
.result-stat.green .result-stat-value { color: var(--teal); }
.result-stat.red .result-stat-value { color: var(--red); }
.result-stat.gold .result-stat-value { color: var(--gold); }
.result-stat.orange .result-stat-value { color: var(--orange); }
.result-stat.cyan .result-stat-value { color: var(--cyan); }
.result-stat.purple .result-stat-value { color: var(--purple); }

.results-best {
    font-size: 0.7rem; color: var(--gold); font-weight: 600;
    display: none; margin-top: 4px;
}
.results-best.show { display: block; animation: bestPop 0.5s ease; }
@keyframes bestPop {
    0% { transform: scale(0.8); opacity: 0; }
    50% { transform: scale(1.15); }
    100% { transform: scale(1); opacity: 1; }
}

.results-btns { display: flex; gap: 10px; width: 100%; max-width: 320px; margin-top: 4px; }
.results-btns .action-btn { flex: 1; font-size: 1rem; padding: 12px; }
.btn-secondary {
    background: var(--card) !important; color: var(--text) !important;
    border: 1px solid var(--border) !important;
    -webkit-text-fill-color: var(--text) !important;
}
.btn-secondary:hover { border-color: rgba(255,215,0,0.3) !important; }

/* ‚ïê‚ïê‚ïê GAMEPAD INDICATOR ‚ïê‚ïê‚ïê */
.gamepad-indicator {
    position: fixed; bottom: 12px; right: 12px; z-index: 50;
    padding: 4px 10px; border-radius: 20px;
    background: rgba(0,217,165,0.1); border: 1px solid rgba(0,217,165,0.3);
    font-size: 0.6rem; color: var(--teal); font-weight: 600;
    display: none; align-items: center; gap: 4px;
}
.gamepad-indicator.connected { display: flex; }

/* ‚ïê‚ïê‚ïê RESPONSIVE ‚ïê‚ïê‚ïê */
@media (max-width: 380px) {
    .prompt-card { width: 90px; height: 90px; }
    .prompt-symbol { font-size: 1.8rem; }
    .zone { width: 72px; height: 72px; }
    .zone-symbol { font-size: 1.4rem; }
    .hud-stat-value { font-size: 1.2rem; }
    .results-score { font-size: 3rem; }
}
@media (min-width: 500px) {
    .arena-inner { max-width: 400px; }
    .prompt-card { width: 130px; height: 130px; }
    .prompt-symbol { font-size: 2.6rem; }
    .zone { width: 100px; height: 100px; }
    .zone-symbol { font-size: 2rem; }
}

/* ‚ïê‚ïê‚ïê SCREEN FLASH ‚ïê‚ïê‚ïê */
.screen-flash {
    position: fixed; inset: 0; z-index: 200; pointer-events: none; opacity: 0;
}
.screen-flash.correct-flash {
    background: var(--teal); animation: screenFlash 0.3s ease;
}
.screen-flash.wrong-flash {
    background: var(--red); animation: screenFlash 0.3s ease;
}
@keyframes screenFlash {
    0% { opacity: 0.15; }
    100% { opacity: 0; }
}
</style>
</head>
<body>

<!-- Screen Flash -->
<div class="screen-flash" id="screenFlash"></div>

<!-- Back Nav -->
<nav class="back-nav">
    <a href="/dashboard.html" class="back-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
        DASHBOARD
    </a>
    <div class="nav-title">CLUTCH TIMER</div>
    <div class="nav-badge" id="navTierBadge" style="display:none;"></div>
</nav>

<!-- Gamepad Indicator -->
<div class="gamepad-indicator" id="gamepadIndicator">üéÆ CONTROLLER</div>

<div class="game-container">

    <!-- ‚ïê‚ïê‚ïê TIER SELECT SCREEN ‚ïê‚ïê‚ïê -->
    <div class="screen active" id="screenSelect">
        <div class="tier-select">
            <div class="tier-header">
                <h1>CLUTCH TIMER</h1>
                <p>Decision Quality Under Cognitive Load</p>
            </div>

            <div class="tier-card tier-bronze" data-tier="bronze" onclick="selectTier('bronze')">
                <div class="tier-icon">B</div>
                <div class="tier-info">
                    <div class="tier-name">BRONZE</div>
                    <div class="tier-desc">Binary choice, single rule. Learn the system.</div>
                    <div class="tier-stats">
                        <div class="tier-stat">Zones: <span>2</span></div>
                        <div class="tier-stat">Window: <span>3.0s</span></div>
                        <div class="tier-stat">Rules: <span>1</span></div>
                    </div>
                </div>
                <div class="tier-best" id="bestBronze">
                    <div class="tier-best-label">BEST</div>
                    <div class="tier-best-value">‚Äî</div>
                </div>
            </div>

            <div class="tier-card tier-silver" data-tier="silver" onclick="selectTier('silver')">
                <div class="tier-icon">S</div>
                <div class="tier-info">
                    <div class="tier-name">SILVER</div>
                    <div class="tier-desc">Third zone. Two prompt types. Think faster.</div>
                    <div class="tier-stats">
                        <div class="tier-stat">Zones: <span>3</span></div>
                        <div class="tier-stat">Window: <span>2.5s</span></div>
                        <div class="tier-stat">Rules: <span>1</span></div>
                    </div>
                </div>
                <div class="tier-best" id="bestSilver">
                    <div class="tier-best-label">BEST</div>
                    <div class="tier-best-value">‚Äî</div>
                </div>
            </div>

            <div class="tier-card tier-gold" data-tier="gold" onclick="selectTier('gold')">
                <div class="tier-icon">G</div>
                <div class="tier-info">
                    <div class="tier-name">GOLD</div>
                    <div class="tier-desc">Full arena. Stacked rules. Mid-round switches.</div>
                    <div class="tier-stats">
                        <div class="tier-stat">Zones: <span>4</span></div>
                        <div class="tier-stat">Window: <span>2.0s</span></div>
                        <div class="tier-stat">Rules: <span>2</span></div>
                    </div>
                </div>
                <div class="tier-best" id="bestGold">
                    <div class="tier-best-label">BEST</div>
                    <div class="tier-best-value">‚Äî</div>
                </div>
            </div>

            <div class="tier-card tier-diamond" data-tier="diamond" onclick="selectTier('diamond')">
                <div class="tier-icon">D</div>
                <div class="tier-info">
                    <div class="tier-name">DIAMOND</div>
                    <div class="tier-desc">Priority chains. Find the BEST answer, not just valid.</div>
                    <div class="tier-stats">
                        <div class="tier-stat">Zones: <span>4</span></div>
                        <div class="tier-stat">Window: <span>1.5s</span></div>
                        <div class="tier-stat">Rules: <span>2</span></div>
                    </div>
                </div>
                <div class="tier-best" id="bestDiamond">
                    <div class="tier-best-label">BEST</div>
                    <div class="tier-best-value">‚Äî</div>
                </div>
            </div>

            <div class="tier-card tier-radiant" data-tier="radiant" onclick="selectTier('radiant')">
                <div class="tier-icon">R</div>
                <div class="tier-info">
                    <div class="tier-name">RADIANT</div>
                    <div class="tier-desc">Conflicting rules. Cognitive overload. The ultimate test.</div>
                    <div class="tier-stats">
                        <div class="tier-stat">Zones: <span>4</span></div>
                        <div class="tier-stat">Window: <span>1.2s</span></div>
                        <div class="tier-stat">Rules: <span>3</span></div>
                    </div>
                </div>
                <div class="tier-best" id="bestRadiant">
                    <div class="tier-best-label">BEST</div>
                    <div class="tier-best-value">‚Äî</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê GAME PLAY SCREEN ‚ïê‚ïê‚ïê -->
    <div class="screen" id="screenGame">
        <div class="game-play">
            <!-- HUD -->
            <div class="hud">
                <div class="hud-left">
                    <div class="hud-stat">
                        <div class="hud-stat-value hud-score" id="hudScore">0</div>
                        <div class="hud-stat-label">Score</div>
                    </div>
                    <div class="hud-stat">
                        <div class="hud-stat-value hud-streak" id="hudStreak">0</div>
                        <div class="hud-stat-label">Streak</div>
                    </div>
                </div>
                <div class="hud-right">
                    <div class="hud-stat">
                        <div class="hud-stat-value hud-accuracy" id="hudAccuracy">‚Äî</div>
                        <div class="hud-stat-label">Acc%</div>
                    </div>
                    <div class="hud-stat">
                        <div class="hud-stat-value hud-prompt-count" id="hudPrompt">0/25</div>
                        <div class="hud-stat-label">Prompt</div>
                    </div>
                </div>
            </div>

            <!-- Active Rules -->
            <div class="rules-bar" id="rulesBar">
                <div class="rule-badge" id="rule1">MATCH COLOR</div>
            </div>

            <!-- Timer Bar -->
            <div class="timer-bar-container">
                <div class="timer-bar" id="timerBar" style="width:100%"></div>
            </div>

            <!-- Decision Arena -->
            <div class="arena">
                <div class="arena-inner" id="arenaInner">
                    <!-- Zones injected by JS -->
                    <div class="zone zone-top" id="zone0" onclick="chooseZone(0)">
                        <div class="zone-symbol"></div>
                        <div class="zone-label">‚ñ≤</div>
                    </div>
                    <div class="zone zone-right hidden" id="zone1" onclick="chooseZone(1)">
                        <div class="zone-symbol"></div>
                        <div class="zone-label">‚ñ∂</div>
                    </div>
                    <div class="zone zone-bottom" id="zone2" onclick="chooseZone(2)">
                        <div class="zone-symbol"></div>
                        <div class="zone-label">‚ñº</div>
                    </div>
                    <div class="zone zone-left hidden" id="zone3" onclick="chooseZone(3)">
                        <div class="zone-symbol"></div>
                        <div class="zone-label">‚óÄ</div>
                    </div>

                    <!-- Central Prompt -->
                    <div class="prompt-card" id="promptCard">
                        <div class="prompt-symbol" id="promptSymbol">‚è±</div>
                        <div class="prompt-label" id="promptLabel">READY</div>
                    </div>

                    <!-- Speed bonus popup -->
                    <div class="speed-popup" id="speedPopup"></div>
                </div>
            </div>

            <!-- Feedback -->
            <div class="feedback-bar">
                <div class="feedback-text" id="feedbackText">Select a tier and press GO</div>
            </div>

            <!-- Action Button -->
            <button class="action-btn" id="actionBtn" onclick="startRound()">GO</button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê RESULTS SCREEN ‚ïê‚ïê‚ïê -->
    <div class="screen" id="screenResults">
        <div class="results">
            <div class="results-tier" id="resultsTier">BRONZE</div>
            <div class="results-score" id="resultsScore">0</div>
            <div class="results-label">TOTAL SCORE</div>
            <div class="results-best" id="resultsBest">‚òÖ NEW PERSONAL BEST!</div>

            <div class="results-grid">
                <div class="result-stat green">
                    <div class="result-stat-value" id="resCorrect">0</div>
                    <div class="result-stat-label">Correct</div>
                </div>
                <div class="result-stat red">
                    <div class="result-stat-value" id="resWrong">0</div>
                    <div class="result-stat-label">Wrong</div>
                </div>
                <div class="result-stat orange">
                    <div class="result-stat-value" id="resTimeout">0</div>
                    <div class="result-stat-label">Timeout</div>
                </div>
                <div class="result-stat cyan">
                    <div class="result-stat-value" id="resAccuracy">0%</div>
                    <div class="result-stat-label">Accuracy</div>
                </div>
                <div class="result-stat gold">
                    <div class="result-stat-value" id="resBestStreak">0</div>
                    <div class="result-stat-label">Best Streak</div>
                </div>
                <div class="result-stat purple">
                    <div class="result-stat-value" id="resAvgTime">0ms</div>
                    <div class="result-stat-label">Avg Time</div>
                </div>
            </div>

            <div class="results-btns">
                <button class="action-btn btn-secondary" onclick="backToSelect()">TIERS</button>
                <button class="action-btn" onclick="replayTier()">PLAY AGAIN</button>
            </div>
        </div>
    </div>

</div>

<script>
/*‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê*/
/*  CLUTCH TIMER ‚Äî GAME ENGINE                              */
/*‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê*/
(function(){
'use strict';

// ‚ïê‚ïê‚ïê TIER CONFIGS ‚ïê‚ïê‚ïê
const TIERS = {
    bronze:  { zones: 2, promptTypes: ['color'], rulesActive: 1, ruleChangeEvery: 0, windowStart: 3000, label: 'BRONZE', color: '#CD7F32' },
    silver:  { zones: 3, promptTypes: ['color','symbol'], rulesActive: 1, ruleChangeEvery: 0, windowStart: 2500, label: 'SILVER', color: '#C0C0C0' },
    gold:    { zones: 4, promptTypes: ['color','symbol','direction'], rulesActive: 2, ruleChangeEvery: 8, windowStart: 2000, label: 'GOLD', color: '#FFD700' },
    diamond: { zones: 4, promptTypes: ['color','symbol','direction','priority'], rulesActive: 2, ruleChangeEvery: 5, windowStart: 1500, label: 'DIAMOND', color: '#B9F2FF' },
    radiant: { zones: 4, promptTypes: ['color','symbol','direction','priority','conflict'], rulesActive: 3, ruleChangeEvery: 3, windowStart: 1200, label: 'RADIANT', color: '#FF6B35' }
};

// ‚ïê‚ïê‚ïê SYMBOLS & COLORS ‚ïê‚ïê‚ïê
const COLORS = [
    { name: 'red', symbol: 'üî¥', hex: '#FF3B5C' },
    { name: 'blue', symbol: 'üîµ', hex: '#60A5FA' },
    { name: 'green', symbol: 'üü¢', hex: '#00D9A5' },
    { name: 'gold', symbol: 'üü°', hex: '#FFD700' }
];
const SYMBOLS = [
    { name: 'bolt', symbol: '‚ö°', pair: 'üå©' },
    { name: 'star', symbol: '‚≠ê', pair: '‚ú®' },
    { name: 'fire', symbol: 'üî•', pair: 'üí•' },
    { name: 'diamond', symbol: 'üíé', pair: 'üî∑' }
];
const DIRECTIONS = [
    { name: 'up', symbol: '‚Üë', opposite: 2, label: 'UP' },
    { name: 'right', symbol: '‚Üí', opposite: 3, label: 'RIGHT' },
    { name: 'down', symbol: '‚Üì', opposite: 0, label: 'DOWN' },
    { name: 'left', symbol: '‚Üê', opposite: 1, label: 'LEFT' }
];

// ‚ïê‚ïê‚ïê RULE DEFINITIONS ‚ïê‚ïê‚ïê
const RULES = {
    matchColor:     { label: 'MATCH COLOR', desc: 'Click the zone with the matching color' },
    matchSymbol:    { label: 'MATCH SYMBOL', desc: 'Click the zone with the matching symbol pair' },
    followArrow:    { label: 'FOLLOW ARROW', desc: 'Click the zone the arrow points to' },
    oppositeArrow:  { label: 'OPPOSITE ‚Üî', desc: 'Click the OPPOSITE direction of the arrow' },
    highestPriority:{ label: 'HIGHEST FIRST', desc: 'Among valid zones, pick the highest priority' },
    lowestPriority: { label: 'LOWEST FIRST', desc: 'Among valid zones, pick the lowest priority' }
};

// Scoring
const SCORE_CORRECT = 100;
const SCORE_SPEED_800 = 40;
const SCORE_SPEED_500 = 80;
const SCORE_SPEED_300 = 120;
const SCORE_STREAK_5 = 50;
const SCORE_WRONG = -150;
const SCORE_TIMEOUT = -50;

const PROMPTS_PER_ROUND = 25;
const SHRINK_SCHEDULE = [
    { start: 1,  end: 5,  factor: 1.0 },
    { start: 6,  end: 10, factor: 0.85 },
    { start: 11, end: 15, factor: 0.70 },
    { start: 16, end: 20, factor: 0.55 },
    { start: 21, end: 25, factor: 0.45 }
];

// ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê
let currentTier = null;
let tierConfig = null;
let promptIndex = 0;
let score = 0;
let streak = 0;
let bestStreak = 0;
let correct = 0;
let wrong = 0;
let timeouts = 0;
let totalResponseTime = 0;
let responseTimes = [];
let activeRules = [];
let currentCorrectZone = -1;
let currentPromptType = '';
let promptStartTime = 0;
let timerInterval = null;
let timerTimeout = null;
let isWaiting = false;
let roundActive = false;
let zonePriorities = [];

// DOM refs
const $ = id => document.getElementById(id);
const screenSelect = $('screenSelect');
const screenGame = $('screenGame');
const screenResults = $('screenResults');
const hudScore = $('hudScore');
const hudStreak = $('hudStreak');
const hudAccuracy = $('hudAccuracy');
const hudPrompt = $('hudPrompt');
const rulesBar = $('rulesBar');
const timerBar = $('timerBar');
const promptCard = $('promptCard');
const promptSymbol = $('promptSymbol');
const promptLabel = $('promptLabel');
const feedbackText = $('feedbackText');
const actionBtn = $('actionBtn');
const speedPopup = $('speedPopup');
const screenFlash = $('screenFlash');
const navTierBadge = $('navTierBadge');
const zones = [0,1,2,3].map(i => $('zone'+i));

// ‚ïê‚ïê‚ïê SCREEN MANAGEMENT ‚ïê‚ïê‚ïê
function showScreen(screen) {
    [screenSelect, screenGame, screenResults].forEach(s => s.classList.remove('active'));
    screen.classList.add('active');
}

// ‚ïê‚ïê‚ïê BEST SCORES ‚ïê‚ïê‚ïê
function getBest(tier) {
    return parseInt(localStorage.getItem('bos-clutch-best-' + tier) || '0');
}
function setBest(tier, val) {
    localStorage.setItem('bos-clutch-best-' + tier, val);
}
function loadBests() {
    Object.keys(TIERS).forEach(t => {
        const best = getBest(t);
        const el = $('best' + t.charAt(0).toUpperCase() + t.slice(1));
        if (el) {
            el.querySelector('.tier-best-value').textContent = best > 0 ? best : '‚Äî';
        }
    });
}

// ‚ïê‚ïê‚ïê TIER SELECT ‚ïê‚ïê‚ïê
window.selectTier = function(tier) {
    const card = document.querySelector('.tier-card[data-tier="'+tier+'"]');
    if (card && card.classList.contains('locked')) return;
    currentTier = tier;
    tierConfig = TIERS[tier];
    resetRound();
    showScreen(screenGame);
    setupArena();
    // Show tier badge in nav
    navTierBadge.textContent = tierConfig.label;
    navTierBadge.style.display = 'inline-block';
    navTierBadge.style.background = 'rgba(255,255,255,0.06)';
    navTierBadge.style.color = tierConfig.color;
    navTierBadge.style.borderColor = tierConfig.color;
    feedbackText.textContent = 'Press GO to begin';
    feedbackText.className = 'feedback-text';
    actionBtn.textContent = 'GO';
    actionBtn.disabled = false;
    actionBtn.style.display = 'block';
};

// ‚ïê‚ïê‚ïê SETUP ARENA ‚ïê‚ïê‚ïê
function setupArena() {
    const numZones = tierConfig.zones;
    // Bronze: 2 zones (top/bottom). Silver: 3 (top/right/bottom). Gold+: 4
    if (numZones === 2) {
        zones[0].classList.remove('hidden'); // top
        zones[1].classList.add('hidden');    // right
        zones[2].classList.remove('hidden'); // bottom
        zones[3].classList.add('hidden');    // left
    } else if (numZones === 3) {
        zones[0].classList.remove('hidden'); // top
        zones[1].classList.remove('hidden'); // right
        zones[2].classList.remove('hidden'); // bottom
        zones[3].classList.add('hidden');    // left
    } else {
        zones.forEach(z => z.classList.remove('hidden'));
    }
    // Clear states
    zones.forEach(z => {
        z.className = z.className.replace(/ correct| wrong| reveal| timeout-correct/g, '');
        z.removeAttribute('data-color');
    });
    promptCard.classList.remove('active');
}

// ‚ïê‚ïê‚ïê RESET ROUND ‚ïê‚ïê‚ïê
function resetRound() {
    promptIndex = 0;
    score = 0;
    streak = 0;
    bestStreak = 0;
    correct = 0;
    wrong = 0;
    timeouts = 0;
    totalResponseTime = 0;
    responseTimes = [];
    activeRules = [];
    currentCorrectZone = -1;
    isWaiting = false;
    roundActive = false;
    zonePriorities = [];
    clearTimeout(timerTimeout);
    clearInterval(timerInterval);
    updateHUD();
}

// ‚ïê‚ïê‚ïê START ROUND ‚ïê‚ïê‚ïê
window.startRound = function() {
    if (roundActive) return;
    roundActive = true;
    actionBtn.style.display = 'none';
    // Init rules
    activeRules = generateRules();
    updateRulesDisplay();
    // Start first prompt
    nextPrompt();
};

// ‚ïê‚ïê‚ïê GENERATE RULES ‚ïê‚ïê‚ïê
function generateRules() {
    const rules = [];
    const tier = currentTier;
    if (tier === 'bronze') {
        rules.push('matchColor');
    } else if (tier === 'silver') {
        // Randomly pick color or symbol
        rules.push(Math.random() < 0.5 ? 'matchColor' : 'matchSymbol');
    } else if (tier === 'gold') {
        rules.push(Math.random() < 0.5 ? 'matchColor' : 'matchSymbol');
        rules.push(Math.random() < 0.5 ? 'followArrow' : 'oppositeArrow');
    } else if (tier === 'diamond') {
        rules.push(Math.random() < 0.5 ? 'matchColor' : 'matchSymbol');
        rules.push(Math.random() < 0.5 ? 'highestPriority' : 'lowestPriority');
    } else { // radiant
        rules.push(Math.random() < 0.5 ? 'matchColor' : 'matchSymbol');
        rules.push(Math.random() < 0.5 ? 'followArrow' : 'oppositeArrow');
        rules.push(Math.random() < 0.5 ? 'highestPriority' : 'lowestPriority');
    }
    return rules;
}

function switchRules() {
    const oldLabels = activeRules.map(r => RULES[r].label).join(' + ');
    activeRules = generateRules();
    const newLabels = activeRules.map(r => RULES[r].label).join(' + ');
    if (newLabels !== oldLabels) {
        updateRulesDisplay(true);
        feedbackText.textContent = '‚ö° RULES CHANGED!';
        feedbackText.className = 'feedback-text rule-change';
    }
}

// ‚ïê‚ïê‚ïê RULES DISPLAY ‚ïê‚ïê‚ïê
function updateRulesDisplay(isNew) {
    rulesBar.innerHTML = '';
    activeRules.forEach((r, i) => {
        const badge = document.createElement('div');
        badge.className = 'rule-badge' + (isNew ? ' new' : '');
        // Mark conflicts
        if (currentTier === 'radiant' && hasConflict()) {
            badge.classList.add('conflict');
        }
        badge.textContent = RULES[r].label;
        rulesBar.appendChild(badge);
    });
    if (isNew) {
        rulesBar.classList.add('rule-change');
        setTimeout(() => rulesBar.classList.remove('rule-change'), 600);
    }
}

function hasConflict() {
    const hasFollow = activeRules.includes('followArrow');
    const hasOpposite = activeRules.includes('oppositeArrow');
    return hasFollow && hasOpposite;
}

// ‚ïê‚ïê‚ïê DECISION WINDOW CALCULATION ‚ïê‚ïê‚ïê
function getDecisionWindow() {
    const base = tierConfig.windowStart;
    let factor = 1.0;
    for (const s of SHRINK_SCHEDULE) {
        if (promptIndex + 1 >= s.start && promptIndex + 1 <= s.end) {
            factor = s.factor;
            break;
        }
    }
    return base * factor;
}

// ‚ïê‚ïê‚ïê NEXT PROMPT ‚ïê‚ïê‚ïê
function nextPrompt() {
    if (promptIndex >= PROMPTS_PER_ROUND || !roundActive) {
        endRound();
        return;
    }

    // Check for rule changes
    const rce = tierConfig.ruleChangeEvery;
    if (rce > 0 && promptIndex > 0 && promptIndex % rce === 0) {
        switchRules();
    }

    isWaiting = true;
    promptIndex++;
    updateHUD();

    // Clear previous zone states
    zones.forEach(z => {
        z.className = z.className.replace(/ correct| wrong| reveal| timeout-correct/g, '');
        z.removeAttribute('data-color');
        z.style.pointerEvents = 'auto';
    });

    // Generate prompt based on active rules and tier
    generatePrompt();

    // Start timer
    const window = getDecisionWindow();
    promptStartTime = performance.now();
    startTimer(window);
    promptCard.classList.add('active');
}

// ‚ïê‚ïê‚ïê GENERATE PROMPT ‚ïê‚ïê‚ïê
function generatePrompt() {
    const numZones = tierConfig.zones;
    const zoneIndices = getActiveZoneIndices();

    // Determine primary rule for prompt type
    const primaryRule = activeRules[0];
    let type, correctIdx;

    if (primaryRule === 'matchColor' || (primaryRule === 'matchSymbol' && currentTier === 'bronze')) {
        type = 'color';
        // Pick a color for the prompt
        const colorPool = COLORS.slice(0, numZones);
        const promptColor = colorPool[Math.floor(Math.random() * colorPool.length)];
        promptSymbol.textContent = promptColor.symbol;
        promptLabel.textContent = 'MATCH';

        // Assign colors to zones (one matches)
        const shuffled = shuffle([...colorPool]);
        // Ensure prompt color is in there
        if (!shuffled.find(c => c.name === promptColor.name)) {
            shuffled[0] = promptColor;
        }
        zoneIndices.forEach((zi, i) => {
            const c = shuffled[i % shuffled.length];
            zones[zi].querySelector('.zone-symbol').textContent = c.symbol;
            zones[zi].querySelector('.zone-label').textContent = c.name.toUpperCase();
            zones[zi].setAttribute('data-color', c.name);
            if (c.name === promptColor.name) correctIdx = zi;
        });
    }
    else if (primaryRule === 'matchSymbol') {
        type = 'symbol';
        const symPool = SYMBOLS.slice(0, numZones);
        const promptSym = symPool[Math.floor(Math.random() * symPool.length)];
        promptSymbol.textContent = promptSym.symbol;
        promptLabel.textContent = 'MATCH PAIR';

        const shuffled = shuffle([...symPool]);
        if (!shuffled.find(s => s.name === promptSym.name)) {
            shuffled[0] = promptSym;
        }
        zoneIndices.forEach((zi, i) => {
            const s = shuffled[i % shuffled.length];
            zones[zi].querySelector('.zone-symbol').textContent = s.pair;
            zones[zi].querySelector('.zone-label').textContent = s.name.toUpperCase();
            if (s.name === promptSym.name) correctIdx = zi;
        });
    }

    // Apply directional rule overlay (Gold+)
    if (activeRules.includes('followArrow') || activeRules.includes('oppositeArrow')) {
        // For direction prompts, override based on a coin flip per prompt
        if (Math.random() < 0.4 && currentTier !== 'bronze' && currentTier !== 'silver') {
            type = 'direction';
            const dir = DIRECTIONS[zoneIndices[Math.floor(Math.random() * zoneIndices.length)]];
            promptSymbol.textContent = dir.symbol;

            if (activeRules.includes('oppositeArrow')) {
                promptLabel.textContent = 'OPPOSITE';
                correctIdx = dir.opposite;
                // Ensure opposite zone is active
                if (!zoneIndices.includes(correctIdx)) {
                    correctIdx = zoneIndices[Math.floor(Math.random() * zoneIndices.length)];
                }
            } else {
                promptLabel.textContent = 'FOLLOW';
                correctIdx = zoneIndices.find(z => z === DIRECTIONS.findIndex(d => d.name === dir.name));
                if (correctIdx === undefined) correctIdx = zoneIndices[0];
            }
        }
    }

    // Priority rule overlay (Diamond+)
    if (activeRules.includes('highestPriority') || activeRules.includes('lowestPriority')) {
        // Assign random priorities to zones
        zonePriorities = [];
        zoneIndices.forEach(zi => {
            const pri = Math.floor(Math.random() * 9) + 1;
            zonePriorities.push({ zone: zi, priority: pri });
            zones[zi].querySelector('.zone-label').textContent = '‚òÖ' + pri;
        });

        if (type !== 'direction') {
            // Multiple "correct" by color/symbol, pick by priority
            const validZones = zoneIndices.filter(zi => {
                if (type === 'color') {
                    return zones[zi].getAttribute('data-color') === zones[correctIdx]?.getAttribute('data-color');
                }
                return zi === correctIdx;
            });

            if (validZones.length > 1 || Math.random() < 0.5) {
                // Make multiple zones "valid" and pick by priority
                const validPris = zonePriorities.filter(p => zoneIndices.includes(p.zone));
                if (activeRules.includes('highestPriority')) {
                    promptLabel.textContent += ' + HIGHEST ‚òÖ';
                    validPris.sort((a, b) => b.priority - a.priority);
                } else {
                    promptLabel.textContent += ' + LOWEST ‚òÖ';
                    validPris.sort((a, b) => a.priority - b.priority);
                }
                correctIdx = validPris[0].zone;
            }
        }
    }

    // Conflict resolution (Radiant): if both followArrow and oppositeArrow, 
    // the LAST rule in activeRules takes precedence
    if (hasConflict()) {
        promptLabel.textContent = '‚ö† CONFLICT';
    }

    currentCorrectZone = correctIdx;
    currentPromptType = type;
}

function getActiveZoneIndices() {
    const n = tierConfig.zones;
    if (n === 2) return [0, 2]; // top, bottom
    if (n === 3) return [0, 1, 2]; // top, right, bottom
    return [0, 1, 2, 3]; // all
}

// ‚ïê‚ïê‚ïê TIMER ‚ïê‚ïê‚ïê
function startTimer(duration) {
    const startTime = performance.now();
    timerBar.style.width = '100%';
    timerBar.className = 'timer-bar';

    clearInterval(timerInterval);
    clearTimeout(timerTimeout);

    timerInterval = setInterval(() => {
        const elapsed = performance.now() - startTime;
        const pct = Math.max(0, 1 - elapsed / duration) * 100;
        timerBar.style.width = pct + '%';

        if (pct < 25) {
            timerBar.className = 'timer-bar critical';
        } else if (pct < 50) {
            timerBar.className = 'timer-bar warning';
        }
    }, 30);

    timerTimeout = setTimeout(() => {
        handleTimeout();
    }, duration);
}

function stopTimer() {
    clearInterval(timerInterval);
    clearTimeout(timerTimeout);
}

// ‚ïê‚ïê‚ïê ZONE CLICK ‚ïê‚ïê‚ïê
window.chooseZone = function(zoneIdx) {
    if (!isWaiting || !roundActive) return;
    isWaiting = false;
    stopTimer();

    const responseTime = performance.now() - promptStartTime;
    responseTimes.push(responseTime);
    totalResponseTime += responseTime;

    if (zoneIdx === currentCorrectZone) {
        handleCorrect(zoneIdx, responseTime);
    } else {
        handleWrong(zoneIdx);
    }
};

// ‚ïê‚ïê‚ïê HANDLE CORRECT ‚ïê‚ïê‚ïê
function handleCorrect(zoneIdx, responseTime) {
    correct++;
    streak++;
    if (streak > bestStreak) bestStreak = streak;

    // Base score
    let points = SCORE_CORRECT;

    // Speed bonus
    let speedBonus = 0;
    let speedLabel = '';
    if (responseTime < 300) {
        speedBonus = SCORE_SPEED_300;
        speedLabel = '+120 LIGHTNING';
    } else if (responseTime < 500) {
        speedBonus = SCORE_SPEED_500;
        speedLabel = '+80 FAST';
    } else if (responseTime < 800) {
        speedBonus = SCORE_SPEED_800;
        speedLabel = '+40 QUICK';
    }
    points += speedBonus;

    // Streak bonus
    if (streak > 0 && streak % 5 === 0) {
        points += SCORE_STREAK_5;
        speedLabel = 'üî• STREAK ' + streak + '!';
        feedbackText.textContent = 'üî• ' + streak + ' STREAK! +' + points;
        feedbackText.className = 'feedback-text streak';
    } else {
        feedbackText.textContent = '‚úì CORRECT +' + points + (speedBonus ? ' (' + Math.round(responseTime) + 'ms)' : '');
        feedbackText.className = 'feedback-text correct';
    }

    score += points;

    // Visual feedback
    zones[zoneIdx].classList.add('correct');
    flashScreen('correct');
    promptCard.classList.remove('active');

    // Speed popup
    if (speedLabel) {
        showSpeedPopup(speedLabel, 'var(--teal)');
    }

    updateHUD();
    setTimeout(nextPrompt, 500);
}

// ‚ïê‚ïê‚ïê HANDLE WRONG ‚ïê‚ïê‚ïê
function handleWrong(zoneIdx) {
    wrong++;
    streak = 0;
    score += SCORE_WRONG;

    zones[zoneIdx].classList.add('wrong');
    // Reveal correct
    if (currentCorrectZone >= 0) {
        zones[currentCorrectZone].classList.add('reveal');
    }
    flashScreen('wrong');
    promptCard.classList.remove('active');

    feedbackText.textContent = '‚úó WRONG -150';
    feedbackText.className = 'feedback-text wrong';
    showSpeedPopup('-150', 'var(--red)');

    updateHUD();
    setTimeout(nextPrompt, 700);
}

// ‚ïê‚ïê‚ïê HANDLE TIMEOUT ‚ïê‚ïê‚ïê
function handleTimeout() {
    if (!isWaiting) return;
    isWaiting = false;
    timeouts++;
    streak = 0;
    score += SCORE_TIMEOUT;

    // Reveal correct
    if (currentCorrectZone >= 0) {
        zones[currentCorrectZone].classList.add('timeout-correct');
    }
    promptCard.classList.remove('active');

    feedbackText.textContent = '‚è± TIMEOUT -50';
    feedbackText.className = 'feedback-text timeout';

    updateHUD();
    setTimeout(nextPrompt, 700);
}

// ‚ïê‚ïê‚ïê END ROUND ‚ïê‚ïê‚ïê
function endRound() {
    roundActive = false;
    stopTimer();

    const totalAnswered = correct + wrong;
    const accuracy = totalAnswered > 0 ? Math.round((correct / totalAnswered) * 100) : 0;
    const avgTime = responseTimes.length > 0 ? Math.round(responseTimes.reduce((a,b)=>a+b,0) / responseTimes.length) : 0;

    // Check best
    const prevBest = getBest(currentTier);
    const isNewBest = score > prevBest;
    if (isNewBest) {
        setBest(currentTier, score);
    }

    // Show results
    $('resultsTier').textContent = tierConfig.label;
    $('resultsTier').style.color = tierConfig.color;
    $('resultsScore').textContent = Math.max(0, score);
    $('resCorrect').textContent = correct;
    $('resWrong').textContent = wrong;
    $('resTimeout').textContent = timeouts;
    $('resAccuracy').textContent = accuracy + '%';
    $('resBestStreak').textContent = bestStreak;
    $('resAvgTime').textContent = avgTime + 'ms';

    const bestEl = $('resultsBest');
    if (isNewBest && score > 0) {
        bestEl.classList.add('show');
    } else {
        bestEl.classList.remove('show');
    }

    showScreen(screenResults);
    loadBests();
}

// ‚ïê‚ïê‚ïê NAV ACTIONS ‚ïê‚ïê‚ïê
window.backToSelect = function() {
    roundActive = false;
    stopTimer();
    navTierBadge.style.display = 'none';
    showScreen(screenSelect);
    loadBests();
};

window.replayTier = function() {
    resetRound();
    showScreen(screenGame);
    setupArena();
    feedbackText.textContent = 'Press GO to begin';
    feedbackText.className = 'feedback-text';
    actionBtn.textContent = 'GO';
    actionBtn.disabled = false;
    actionBtn.style.display = 'block';
};

// ‚ïê‚ïê‚ïê HUD ‚ïê‚ïê‚ïê
function updateHUD() {
    hudScore.textContent = Math.max(0, score);
    hudStreak.textContent = streak;
    hudPrompt.textContent = promptIndex + '/' + PROMPTS_PER_ROUND;
    const totalAnswered = correct + wrong;
    hudAccuracy.textContent = totalAnswered > 0 ? Math.round((correct / totalAnswered) * 100) + '%' : '‚Äî';
}

// ‚ïê‚ïê‚ïê VISUAL FX ‚ïê‚ïê‚ïê
function flashScreen(type) {
    screenFlash.className = 'screen-flash ' + type + '-flash';
    setTimeout(() => { screenFlash.className = 'screen-flash'; }, 300);
}

function showSpeedPopup(text, color) {
    speedPopup.textContent = text;
    speedPopup.style.color = color;
    speedPopup.className = 'speed-popup show';
    setTimeout(() => { speedPopup.className = 'speed-popup'; }, 800);
}

// ‚ïê‚ïê‚ïê UTILITIES ‚ïê‚ïê‚ïê
function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
}

// ‚ïê‚ïê‚ïê GAMEPAD SUPPORT ‚ïê‚ïê‚ïê
let gamepadConnected = false;
let gamepadPollInterval = null;
let lastButtons = {};

window.addEventListener('gamepadconnected', (e) => {
    gamepadConnected = true;
    $('gamepadIndicator').classList.add('connected');
    startGamepadPoll();
});
window.addEventListener('gamepaddisconnected', () => {
    gamepadConnected = false;
    $('gamepadIndicator').classList.remove('connected');
    if (gamepadPollInterval) clearInterval(gamepadPollInterval);
});

function startGamepadPoll() {
    if (gamepadPollInterval) clearInterval(gamepadPollInterval);
    gamepadPollInterval = setInterval(pollGamepad, 16);
}

function pollGamepad() {
    const gp = navigator.getGamepads()[0];
    if (!gp) return;

    // D-pad or face buttons ‚Üí zones
    // Up (12) or Y/Triangle (3) ‚Üí zone 0 (top)
    // Right (15) or B/Circle (1) ‚Üí zone 1 (right)
    // Down (13) or A/Cross (0) ‚Üí zone 2 (bottom)
    // Left (14) or X/Square (2) ‚Üí zone 3 (left)
    const mapping = [
        { buttons: [12, 3], zone: 0 }, // Up
        { buttons: [15, 1], zone: 1 }, // Right
        { buttons: [13, 0], zone: 2 }, // Down
        { buttons: [14, 2], zone: 3 }, // Left
    ];

    mapping.forEach(m => {
        m.buttons.forEach(b => {
            if (gp.buttons[b] && gp.buttons[b].pressed && !lastButtons[b]) {
                chooseZone(m.zone);
            }
            if (gp.buttons[b]) lastButtons[b] = gp.buttons[b].pressed;
        });
    });

    // Start/A to begin round
    if (gp.buttons[9] && gp.buttons[9].pressed && !lastButtons[9]) {
        if (!roundActive && screenGame.classList.contains('active')) {
            startRound();
        }
    }
    if (gp.buttons[9]) lastButtons[9] = gp.buttons[9].pressed;
}

// ‚ïê‚ïê‚ïê KEYBOARD SUPPORT ‚ïê‚ïê‚ïê
document.addEventListener('keydown', (e) => {
    if (!isWaiting && !roundActive) {
        if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            if (screenGame.classList.contains('active')) startRound();
        }
        return;
    }
    switch(e.key) {
        case 'ArrowUp':    case 'w': case 'W': e.preventDefault(); chooseZone(0); break;
        case 'ArrowRight': case 'd': case 'D': e.preventDefault(); chooseZone(1); break;
        case 'ArrowDown':  case 's': case 'S': e.preventDefault(); chooseZone(2); break;
        case 'ArrowLeft':  case 'a': case 'A': e.preventDefault(); chooseZone(3); break;
    }
});

// ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
loadBests();

})();
</script>
</body>
</html>