<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BOS ESPORTS ‚Äî Strobe Drill</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --gold: #FFD700;
    --gold-dim: rgba(255, 215, 0, 0.1);
    --gold-glow: rgba(255, 215, 0, 0.3);
    --orange: #FF6B35;
    --orange-glow: rgba(255, 107, 53, 0.3);
    --teal: #00D9A5;
    --teal-dim: rgba(0, 217, 165, 0.08);
    --teal-glow: rgba(0, 217, 165, 0.3);
    --cyan: #00CED1;
    --cyan-glow: rgba(0, 206, 209, 0.3);
    --red: #FF1744;
    --red-dim: rgba(255, 23, 68, 0.08);
    --red-glow: rgba(255, 23, 68, 0.3);
    --dark: #0a0a0f;
    --darker: #050508;
    --card: #111118;
    --text: #FFFFFF;
    --muted: #8892a0;
    --border: rgba(255,255,255,0.08);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--dark);
    color: var(--text);
    font-family: 'Outfit', sans-serif;
    overflow: hidden;
    height: 100vh;
    width: 100vw;
    -webkit-font-smoothing: antialiased;
    user-select: none;
  }

  .game-wrapper { width: 100%; height: 100%; display: flex; flex-direction: column; position: relative; }

  /* ‚ïê‚ïê‚ïê HUD ‚ïê‚ïê‚ïê */
  .hud {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px;
    background: var(--darker);
    border-bottom: 1px solid var(--border);
    z-index: 10;
    flex-shrink: 0;
  }

  .hud-left { display: flex; align-items: center; gap: 10px; }

  .back-btn {
    color: var(--muted);
    text-decoration: none;
    font-size: 0.75rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 5px 10px;
    border: 1px solid var(--border);
    border-radius: 8px;
    transition: all 0.2s;
  }

  .back-btn:hover { color: var(--gold); border-color: var(--gold); }

  .hud-logo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.1rem;
    letter-spacing: 3px;
    color: var(--gold);
  }

  .hud-rank {
    font-size: 0.6rem;
    font-weight: 700;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--dark);
    background: linear-gradient(135deg, var(--gold), var(--orange));
    padding: 3px 10px;
    border-radius: 50px;
  }

  .hud-center { display: flex; gap: 20px; align-items: center; }
  .hud-stat { text-align: center; }

  .hud-stat-value {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.4rem;
    line-height: 1;
    letter-spacing: 1px;
  }

  .hud-stat-value.score-val { color: var(--gold); }
  .hud-stat-value.streak-val { color: var(--teal); }
  .hud-stat-value.miss-val { color: var(--red); }
  .hud-stat-value.time-val { color: var(--text); }

  .hud-stat-label {
    font-size: 0.5rem;
    font-weight: 600;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--muted);
    margin-top: 2px;
  }

  .hud-right { display: flex; align-items: center; gap: 10px; }

  .strobe-readout {
    font-size: 0.65rem;
    color: var(--muted);
    font-weight: 500;
  }

  .strobe-readout strong { color: var(--gold); font-size: 0.75rem; }

  .input-indicator {
    font-size: 0.55rem;
    font-weight: 600;
    letter-spacing: 1px;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    border: 1px solid var(--border);
    border-radius: 6px;
    transition: all 0.3s;
  }

  .input-indicator.controller-active { color: var(--teal); border-color: rgba(0,217,165,0.2); background: var(--teal-dim); }
  .input-indicator.mouse-active { color: var(--muted); border-color: var(--border); }
  .input-icon { font-size: 0.75rem; }

  /* ‚ïê‚ïê‚ïê PLAY AREA ‚ïê‚ïê‚ïê */
  .play-area {
    flex: 1;
    position: relative;
    overflow: hidden;
    cursor: crosshair;
  }

  .play-area.controller-mode { cursor: none; }

  .grid-overlay {
    position: absolute;
    inset: 0;
    background-image:
      linear-gradient(rgba(255,215,0,0.015) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255,215,0,0.015) 1px, transparent 1px);
    background-size: 50px 50px;
    pointer-events: none;
  }

  .center-mark {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    pointer-events: none;
    opacity: 0.05;
  }

  .center-mark::before, .center-mark::after { content: ''; position: absolute; background: var(--gold); }
  .center-mark::before { width: 40px; height: 1px; top: 0; left: -20px; }
  .center-mark::after { width: 1px; height: 40px; top: -20px; left: 0; }

  .strobe-overlay {
    position: absolute; inset: 0; background: var(--dark);
    z-index: 5; pointer-events: none; opacity: 0;
    transition: opacity 0.04s linear;
  }

  .strobe-overlay.active { opacity: 1; }

  /* ‚ïê‚ïê‚ïê GAMEPAD CROSSHAIR ‚ïê‚ïê‚ïê */
  .gamepad-crosshair { position: absolute; z-index: 8; pointer-events: none; display: none; transform: translate(-50%, -50%); }
  .gamepad-crosshair.visible { display: block; }
  .crosshair-outer { width: 40px; height: 40px; position: relative; }
  .crosshair-outer::before { content: ''; position: absolute; top: 19px; left: 0; width: 14px; height: 2px; background: var(--gold); box-shadow: 0 0 8px var(--gold-glow); }
  .crosshair-outer::after { content: ''; position: absolute; top: 19px; right: 0; width: 14px; height: 2px; background: var(--gold); box-shadow: 0 0 8px var(--gold-glow); }
  .crosshair-v-top, .crosshair-v-bottom { position: absolute; left: 19px; width: 2px; height: 14px; background: var(--gold); box-shadow: 0 0 8px var(--gold-glow); }
  .crosshair-v-top { top: 0; }
  .crosshair-v-bottom { bottom: 0; }
  .crosshair-dot { position: absolute; top: 18px; left: 18px; width: 4px; height: 4px; border-radius: 50%; background: var(--gold); box-shadow: 0 0 10px var(--gold-glow); }

  .crosshair-flash { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 50px; height: 50px; border: 1px solid var(--gold); border-radius: 50%; opacity: 0; box-shadow: 0 0 20px var(--gold-glow); transition: none; }
  .crosshair-flash.firing { animation: crosshairFire 0.2s ease-out forwards; }

  .gamepad-crosshair.on-target .crosshair-outer::before,
  .gamepad-crosshair.on-target .crosshair-outer::after,
  .gamepad-crosshair.on-target .crosshair-v-top,
  .gamepad-crosshair.on-target .crosshair-v-bottom { background: var(--red); box-shadow: 0 0 8px var(--red-glow); }
  .gamepad-crosshair.on-target .crosshair-dot { background: var(--red); box-shadow: 0 0 10px var(--red-glow); }

  /* ‚ïê‚ïê‚ïê TARGETS ‚ïê‚ïê‚ïê */
  .target { position: absolute; z-index: 3; cursor: crosshair; }

  .target-ring {
    width: 56px; height: 56px; border-radius: 50%;
    border: 2px solid var(--teal);
    background: var(--teal-dim);
    display: flex; align-items: center; justify-content: center;
    position: relative;
    animation: targetPulse 0.8s ease-in-out infinite;
    box-shadow: 0 0 15px var(--teal-glow), inset 0 0 15px rgba(0,217,165,0.05);
  }

  .target-ring::before { content: ''; position: absolute; inset: -8px; border-radius: 50%; border: 1px solid rgba(0,217,165,0.1); animation: targetExpand 1s ease-out infinite; }

  .target-core { width: 16px; height: 16px; position: relative; }
  .target-core::before, .target-core::after { content: ''; position: absolute; background: var(--teal); box-shadow: 0 0 6px var(--teal-glow); }
  .target-core::before { width: 16px; height: 2px; top: 7px; left: 0; }
  .target-core::after { width: 2px; height: 16px; top: 0; left: 7px; }

  .target.bonus .target-ring { border-color: var(--cyan); background: rgba(0,206,209,0.08); box-shadow: 0 0 15px var(--cyan-glow); }
  .target.bonus .target-ring::before { border-color: rgba(0,206,209,0.1); }
  .target.bonus .target-core::before, .target.bonus .target-core::after { background: var(--cyan); box-shadow: 0 0 6px var(--cyan-glow); }

  .target.decoy .target-ring { border-color: var(--red); background: var(--red-dim); border-style: dashed; box-shadow: 0 0 10px var(--red-glow); }
  .target.decoy .target-ring::before { border-color: rgba(255,23,68,0.1); }
  .target.decoy .target-core::before { background: var(--red); box-shadow: 0 0 4px var(--red-glow); width: 10px; left: 3px; }
  .target.decoy .target-core::after { background: var(--red); box-shadow: 0 0 4px var(--red-glow); height: 10px; top: 3px; }

  .hit-effect { position: absolute; width: 56px; height: 56px; border-radius: 50%; border: 2px solid var(--teal); box-shadow: 0 0 20px var(--teal-glow); transform: translate(-50%, -50%); animation: hitBurst 0.5s ease-out forwards; pointer-events: none; z-index: 4; }
  .hit-effect.bonus { border-color: var(--cyan); box-shadow: 0 0 20px var(--cyan-glow); }

  .hit-score { position: absolute; transform: translate(-50%, -50%); font-family: 'Bebas Neue', sans-serif; font-size: 1.4rem; color: var(--gold); text-shadow: 0 0 15px var(--gold-glow); animation: scoreFloat 0.8s ease-out forwards; pointer-events: none; z-index: 6; letter-spacing: 1px; }
  .hit-score.bonus { color: var(--cyan); text-shadow: 0 0 15px var(--cyan-glow); font-size: 1.6rem; }
  .hit-score.penalty { color: var(--red); text-shadow: 0 0 10px var(--red-glow); }

  /* ‚ïê‚ïê‚ïê BOTTOM BAR ‚ïê‚ïê‚ïê */
  .bottom-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 15px;
    background: var(--darker);
    border-top: 1px solid var(--border);
    z-index: 10;
    flex-shrink: 0;
  }

  .strobe-indicator { display: flex; align-items: center; gap: 6px; }

  .strobe-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--gold); box-shadow: 0 0 8px var(--gold-glow); animation: strobeBlink 1s ease-in-out infinite; }

  .strobe-text { font-size: 0.6rem; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; color: var(--muted); }

  .progress-section { display: flex; align-items: center; gap: 10px; }
  .progress-label { font-size: 0.55rem; font-weight: 600; letter-spacing: 1.5px; text-transform: uppercase; color: var(--muted); }
  .progress-track { width: 120px; height: 4px; background: rgba(255,255,255,0.04); border-radius: 2px; overflow: hidden; }
  .progress-fill { height: 100%; background: linear-gradient(90deg, var(--gold), var(--orange)); border-radius: 2px; transition: width 0.3s ease; }

  .accuracy-display { font-family: 'Bebas Neue', sans-serif; font-size: 0.85rem; color: var(--gold); letter-spacing: 2px; }

  /* ‚ïê‚ïê‚ïê SCREEN OVERLAYS ‚ïê‚ïê‚ïê */
  .screen-overlay {
    position: absolute; inset: 0; z-index: 20;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    background: rgba(5, 6, 10, 0.97);
    backdrop-filter: blur(20px);
    text-align: center; padding: 2rem;
  }

  .screen-overlay.hidden { display: none; }

  .start-icon { font-size: 3.5rem; margin-bottom: 1.2rem; animation: float 3s ease-in-out infinite; }

  .start-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: clamp(2.5rem, 6vw, 4rem);
    letter-spacing: 5px;
    line-height: 0.95;
  }

  .start-title .glow { display: block; color: var(--gold); }

  .start-desc {
    font-size: 0.85rem;
    color: var(--muted);
    line-height: 1.7;
    max-width: 440px;
    margin: 1.2rem 0;
  }

  .input-hint {
    font-size: 0.65rem;
    color: var(--muted);
    margin-bottom: 1.2rem;
    display: flex;
    align-items: center;
    gap: 1.5rem;
  }

  .input-hint-item { display: flex; align-items: center; gap: 4px; }
  .input-hint-item .icon { font-size: 0.85rem; }
  .input-hint-item.active { color: var(--teal); }

  .tier-select { display: flex; gap: 6px; margin-bottom: 1.5rem; flex-wrap: wrap; justify-content: center; }

  .tier-btn {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 0.85rem;
    letter-spacing: 2px;
    background: transparent;
    color: var(--muted);
    border: 1px solid var(--border);
    border-radius: 50px;
    padding: 6px 16px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .tier-btn.active { color: var(--dark); background: linear-gradient(135deg, var(--gold), var(--orange)); border-color: transparent; }
  .tier-btn:hover:not(.active) { border-color: rgba(255,255,255,0.15); color: var(--text); }
  .tier-btn.gp-focus { outline: 2px solid var(--cyan); outline-offset: 2px; }

  .start-btn {
    padding: 16px 40px;
    border: none;
    border-radius: 50px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.2rem;
    letter-spacing: 3px;
    cursor: pointer;
    transition: all 0.3s;
    background: linear-gradient(135deg, var(--gold), var(--orange));
    color: var(--dark);
    box-shadow: 0 8px 30px rgba(255,107,53,0.3);
  }

  .start-btn:hover { transform: translateY(-2px); box-shadow: 0 12px 40px rgba(255,107,53,0.4); }
  .start-btn:active { transform: scale(0.98); }

  .btn-back-home {
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--muted);
    text-decoration: none;
    transition: color 0.2s;
    margin-top: 1.2rem;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }

  .btn-back-home:hover { color: var(--gold); }

  .countdown-num {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 8rem;
    color: var(--gold);
    text-shadow: 0 0 60px var(--gold-glow), 0 0 120px rgba(255,215,0,0.15);
    line-height: 1;
    animation: countPop 0.5s ease-out;
    letter-spacing: 5px;
  }

  .countdown-sub {
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--muted);
    margin-top: 1rem;
  }

  /* ‚ïê‚ïê‚ïê RESULTS ‚ïê‚ïê‚ïê */
  .results-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 2px;
    max-width: 480px;
    width: 100%;
    margin: 1.5rem 0;
  }

  .result-cell {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px 10px;
    text-align: center;
  }

  .result-value { font-family: 'Bebas Neue', sans-serif; font-size: 1.8rem; line-height: 1; letter-spacing: 1px; }
  .result-value.gold { color: var(--gold); }
  .result-value.teal { color: var(--teal); }
  .result-value.cyan { color: var(--cyan); }

  .result-label { font-size: 0.5rem; font-weight: 600; letter-spacing: 1.5px; text-transform: uppercase; color: var(--muted); margin-top: 4px; }

  .result-grade { font-family: 'Bebas Neue', sans-serif; font-size: 5rem; line-height: 1; margin-bottom: 4px; letter-spacing: 5px; }
  .result-grade.s-rank { color: var(--gold); text-shadow: 0 0 40px var(--gold-glow); }
  .result-grade.a-rank { color: var(--teal); text-shadow: 0 0 30px var(--teal-glow); }
  .result-grade.b-rank { color: var(--cyan); text-shadow: 0 0 20px var(--cyan-glow); }
  .result-grade.c-rank { color: var(--muted); }

  .result-rank { font-family: 'Bebas Neue', sans-serif; font-size: 0.85rem; letter-spacing: 3px; text-transform: uppercase; margin-bottom: 4px; }
  .result-msg { font-size: 0.75rem; color: var(--muted); margin-bottom: 1rem; }
  .result-input-tag { font-size: 0.6rem; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; color: var(--muted); margin-bottom: 1rem; }

  .btn-group { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }

  .btn-secondary {
    padding: 12px 24px;
    border-radius: 50px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 0.95rem;
    letter-spacing: 2px;
    background: transparent;
    color: var(--text);
    border: 1px solid var(--border);
    cursor: pointer;
    text-decoration: none;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  .btn-secondary:hover { border-color: var(--gold); color: var(--gold); }

  .gp-hints { font-size: 0.55rem; color: var(--muted); letter-spacing: 1px; margin-top: 1rem; display: none; }
  .gp-hints.visible { display: block; }
  .gp-hint-key { display: inline-block; border: 1px solid var(--muted); padding: 2px 6px; font-size: 0.5rem; border-radius: 4px; }

  @keyframes targetPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.06); } }
  @keyframes targetExpand { 0% { transform: scale(1); opacity: 0.5; } 100% { transform: scale(1.8); opacity: 0; } }
  @keyframes hitBurst { 0% { transform: translate(-50%, -50%) scale(1); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(3); opacity: 0; } }
  @keyframes scoreFloat { 0% { transform: translate(-50%, -50%) translateY(0); opacity: 1; } 100% { transform: translate(-50%, -50%) translateY(-60px); opacity: 0; } }
  @keyframes crosshairFire { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; } }
  @keyframes strobeBlink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
  @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
  @keyframes countPop { 0% { transform: scale(0.5); opacity: 0; } 60% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }

  @media (max-width: 600px) {
    .hud-center { gap: 10px; }
    .hud-stat-value { font-size: 1.1rem; }
    .bottom-bar { flex-wrap: wrap; gap: 6px; }
    .progress-section { display: none; }
    .target-ring { width: 48px; height: 48px; }
    .hud-logo { display: none; }
    .input-indicator { display: none; }
  }
</style>
</head>
<body>

<div class="game-wrapper">
  <div class="hud">
    <div class="hud-left">
      <a href="/dashboard" class="back-btn">&larr; Hub</a>
      <div class="hud-logo">BOS ESPORTS</div>
      <div class="hud-rank" id="tierDisplay">BRONZE</div>
    </div>
    <div class="hud-center">
      <div class="hud-stat"><div class="hud-stat-value score-val" id="scoreDisplay">0</div><div class="hud-stat-label">Score</div></div>
      <div class="hud-stat"><div class="hud-stat-value streak-val" id="streakDisplay">0</div><div class="hud-stat-label">Streak</div></div>
      <div class="hud-stat"><div class="hud-stat-value miss-val" id="missDisplay">0</div><div class="hud-stat-label">Missed</div></div>
      <div class="hud-stat"><div class="hud-stat-value time-val" id="timeDisplay">60</div><div class="hud-stat-label">Time</div></div>
    </div>
    <div class="hud-right">
      <div class="input-indicator mouse-active" id="inputIndicator">
        <span class="input-icon" id="inputIcon">&#128433;&#65039;</span>
        <span id="inputLabel">MOUSE</span>
      </div>
      <div class="strobe-readout">STROBE <strong id="strobeRate">OFF</strong> Hz</div>
    </div>
  </div>

  <div class="play-area" id="playArea">
    <div class="grid-overlay"></div>
    <div class="center-mark"></div>
    <div class="strobe-overlay" id="strobeOverlay"></div>
    <div class="gamepad-crosshair" id="gpCrosshair">
      <div class="crosshair-outer">
        <div class="crosshair-v-top"></div>
        <div class="crosshair-v-bottom"></div>
        <div class="crosshair-dot"></div>
      </div>
      <div class="crosshair-flash" id="crosshairFlash"></div>
    </div>
  </div>

  <div class="bottom-bar">
    <div class="strobe-indicator">
      <div class="strobe-dot" id="strobeDot"></div>
      <span class="strobe-text" id="strobeLabel">Strobe Off</span>
    </div>
    <div class="progress-section">
      <span class="progress-label">Round</span>
      <div class="progress-track"><div class="progress-fill" id="progressFill" style="width: 0%"></div></div>
    </div>
    <div class="accuracy-display" id="accuracyDisplay">ACC 100%</div>
  </div>

  <!-- START SCREEN -->
  <div class="screen-overlay" id="startScreen">
    <div class="start-icon">&#127919;</div>
    <h1 class="start-title">Strobe<span class="glow">Drill</span></h1>
    <p class="start-desc">Acquire and eliminate targets while strobe disruptions black out your vision. Trains reaction speed, visual tracking, and target acquisition under cognitive pressure.</p>
    <div class="input-hint" id="inputHints">
      <div class="input-hint-item active"><span class="icon">&#128433;&#65039;</span> Mouse + Click</div>
      <div class="input-hint-item" id="gpHint"><span class="icon">&#127918;</span> Controller ‚Äî Connect to activate</div>
    </div>
    <div class="tier-select" id="tierSelect">
      <button class="tier-btn active" data-tier="1">Bronze</button>
      <button class="tier-btn" data-tier="2">Silver</button>
      <button class="tier-btn" data-tier="3">Gold</button>
      <button class="tier-btn" data-tier="4">Diamond</button>
      <button class="tier-btn" data-tier="5">Radiant</button>
    </div>
    <button class="start-btn" id="startBtn">&#127775; Start Match</button>
    <div class="gp-hints" id="gpStartHints">
      <span class="gp-hint-key">A</span> Start &nbsp; <span class="gp-hint-key">D-Pad</span> Select Rank
    </div>
    <a href="/dashboard" class="btn-back-home">&larr; Back to BOS Esports</a>
  </div>

  <!-- COUNTDOWN -->
  <div class="screen-overlay hidden" id="countdownScreen">
    <div class="countdown-num" id="countdownNumber">3</div>
    <div class="countdown-sub">Match Starting ‚Äî Lock In</div>
  </div>

  <!-- RESULTS -->
  <div class="screen-overlay hidden" id="resultsScreen">
    <div class="result-rank" id="resultRankLabel" style="color: var(--gold)">RADIANT</div>
    <div class="result-grade" id="resultGrade">S</div>
    <div class="result-msg" id="resultMsg">Elite cognitive performance</div>
    <div class="result-input-tag" id="resultInputTag">Played with: Mouse</div>
    <div class="results-grid">
      <div class="result-cell"><div class="result-value gold" id="resultScore">0</div><div class="result-label">Final Score</div></div>
      <div class="result-cell"><div class="result-value teal" id="resultAccuracy">0%</div><div class="result-label">Accuracy</div></div>
      <div class="result-cell"><div class="result-value cyan" id="resultStreak">0</div><div class="result-label">Best Streak</div></div>
      <div class="result-cell"><div class="result-value gold" id="resultHits">0</div><div class="result-label">Eliminations</div></div>
      <div class="result-cell"><div class="result-value teal" id="resultReaction">0ms</div><div class="result-label">Avg Reaction</div></div>
      <div class="result-cell"><div class="result-value cyan" id="resultTier">BRZ</div><div class="result-label">Rank</div></div>
    </div>
    <div class="btn-group">
      <button class="start-btn" id="rematchBtn">Rematch</button>
      <button class="btn-secondary" id="menuBtn">Menu</button>
      <a href="/dashboard" class="btn-secondary">&larr; Hub</a>
    </div>
    <div class="gp-hints" id="gpResultHints">
      <span class="gp-hint-key">A</span> Rematch &nbsp; <span class="gp-hint-key">B</span> Menu
    </div>
  </div>
</div>

<script>
const state = {
  tier: 1, score: 0, streak: 0, bestStreak: 0,
  hits: 0, misses: 0, totalTargets: 0,
  timeLeft: 60, running: false, reactionTimes: [],
  screen: 'start', inputMode: 'mouse',
};

const TIERS = {
  1: { strobeRate: 0,   strobeDark: 0,   targetLife: 2200, spawnRate: 1800, maxTargets: 1, decoys: false, name: 'BRONZE',  short: 'BRZ' },
  2: { strobeRate: 60,  strobeDark: 200, targetLife: 2000, spawnRate: 1600, maxTargets: 2, decoys: false, name: 'SILVER',  short: 'SLV' },
  3: { strobeRate: 90,  strobeDark: 350, targetLife: 1700, spawnRate: 1400, maxTargets: 2, decoys: true,  name: 'GOLD',    short: 'GLD' },
  4: { strobeRate: 120, strobeDark: 450, targetLife: 1400, spawnRate: 1200, maxTargets: 3, decoys: true,  name: 'DIAMOND', short: 'DIA' },
  5: { strobeRate: 150, strobeDark: 550, targetLife: 1100, spawnRate: 1000, maxTargets: 3, decoys: true,  name: 'RADIANT', short: 'RAD' },
};

let config, gameTimer, strobeTimer, spawnTimer, targetIdCounter = 0;
const $ = id => document.getElementById(id);
const playArea = $('playArea');

const gp = { connected: false, index: null, crossX: 0, crossY: 0, sensitivity: 8, deadzone: 0.15, prevButtons: {}, fireHeld: false };

window.addEventListener('gamepadconnected', (e) => {
  gp.connected = true; gp.index = e.gamepad.index; setInputMode('controller');
  const area = playArea.getBoundingClientRect(); gp.crossX = area.width / 2; gp.crossY = area.height / 2; updateCrosshairPosition();
});
window.addEventListener('gamepaddisconnected', () => { gp.connected = false; gp.index = null; setInputMode('mouse'); });

function setInputMode(mode) {
  state.inputMode = mode;
  const ind = $('inputIndicator'), crosshair = $('gpCrosshair');
  if (mode === 'controller') {
    ind.className = 'input-indicator controller-active'; $('inputIcon').textContent = 'üéÆ'; $('inputLabel').textContent = 'CONTROLLER';
    crosshair.classList.add('visible'); playArea.classList.add('controller-mode');
    $('gpHint').innerHTML = '<span class="icon">üéÆ</span> Controller Connected ‚úì'; $('gpHint').classList.add('active');
    document.querySelectorAll('.gp-hints').forEach(h => h.classList.add('visible'));
  } else {
    ind.className = 'input-indicator mouse-active'; $('inputIcon').textContent = 'üñ±Ô∏è'; $('inputLabel').textContent = 'MOUSE';
    crosshair.classList.remove('visible'); playArea.classList.remove('controller-mode');
    document.querySelectorAll('.gp-hints').forEach(h => h.classList.remove('visible'));
  }
}

document.addEventListener('mousemove', () => { if (state.inputMode === 'controller' && !gp.connected) setInputMode('mouse'); });

function updateCrosshairPosition() { const ch = $('gpCrosshair'); ch.style.left = gp.crossX + 'px'; ch.style.top = gp.crossY + 'px'; }

function getCrosshairTarget() {
  const targets = playArea.querySelectorAll('.target');
  for (const t of targets) {
    const r = t.getBoundingClientRect(), pr = playArea.getBoundingClientRect();
    const tx = r.left - pr.left, ty = r.top - pr.top, hitPad = 10;
    if (gp.crossX >= tx - hitPad && gp.crossX <= tx + r.width + hitPad && gp.crossY >= ty - hitPad && gp.crossY <= ty + r.height + hitPad) return t;
  }
  return null;
}

function fireCrosshair() { const flash = $('crosshairFlash'); flash.classList.remove('firing'); void flash.offsetWidth; flash.classList.add('firing'); }
function buttonPressed(gpad, index) { const pressed = gpad.buttons[index] && gpad.buttons[index].pressed; const was = gp.prevButtons[index] || false; gp.prevButtons[index] = pressed; return pressed && !was; }
function triggerValue(gpad, index) { return gpad.buttons[index] ? gpad.buttons[index].value : 0; }

function gamepadLoop() {
  if (!gp.connected) { requestAnimationFrame(gamepadLoop); return; }
  const gpads = navigator.getGamepads(), gpad = gpads[gp.index];
  if (!gpad) { requestAnimationFrame(gamepadLoop); return; }
  const hasInput = gpad.axes.some(a => Math.abs(a) > gp.deadzone) || gpad.buttons.some(b => b.pressed);
  if (hasInput && state.inputMode !== 'controller') { setInputMode('controller'); const area = playArea.getBoundingClientRect(); gp.crossX = area.width / 2; gp.crossY = area.height / 2; }

  if (state.screen === 'start') {
    if (buttonPressed(gpad, 14)) { state.tier = Math.max(1, state.tier - 1); selectTierUI(state.tier); }
    if (buttonPressed(gpad, 15)) { state.tier = Math.min(5, state.tier + 1); selectTierUI(state.tier); }
    if (buttonPressed(gpad, 0)) startCountdown();
  }

  if (state.screen === 'playing') {
    const lx = gpad.axes[0], ly = gpad.axes[1], area = playArea.getBoundingClientRect();
    if (Math.abs(lx) > gp.deadzone) gp.crossX += lx * gp.sensitivity;
    if (Math.abs(ly) > gp.deadzone) gp.crossY += ly * gp.sensitivity;
    gp.crossX = Math.max(0, Math.min(area.width, gp.crossX)); gp.crossY = Math.max(0, Math.min(area.height, gp.crossY));
    updateCrosshairPosition();
    const overTarget = getCrosshairTarget();
    $('gpCrosshair').classList.toggle('on-target', !!overTarget);
    const r2 = triggerValue(gpad, 7), fireTriggered = buttonPressed(gpad, 7) || buttonPressed(gpad, 0) || (r2 > 0.5 && !gp.fireHeld);
    gp.fireHeld = r2 > 0.5;
    if (fireTriggered && state.running) { fireCrosshair(); if (overTarget) hitTarget(overTarget); else { state.misses++; state.streak = 0; updateHUD(); } }
  }

  if (state.screen === 'results') { if (buttonPressed(gpad, 0)) restartGame(); if (buttonPressed(gpad, 1)) backToMenu(); }
  requestAnimationFrame(gamepadLoop);
}
requestAnimationFrame(gamepadLoop);

function selectTierUI(t) { state.tier = t; document.querySelectorAll('.tier-btn').forEach(b => b.classList.toggle('active', parseInt(b.dataset.tier) === t)); }
$('tierSelect').addEventListener('click', (e) => { const btn = e.target.closest('.tier-btn'); if (btn) selectTierUI(parseInt(btn.dataset.tier)); });

$('startBtn').addEventListener('click', startCountdown);
$('rematchBtn').addEventListener('click', restartGame);
$('menuBtn').addEventListener('click', backToMenu);

function startCountdown() {
  state.screen = 'countdown'; $('startScreen').classList.add('hidden'); $('countdownScreen').classList.remove('hidden');
  let count = 3; $('countdownNumber').textContent = count;
  const iv = setInterval(() => { count--; if (count > 0) { $('countdownNumber').textContent = count; $('countdownNumber').style.animation = 'none'; void $('countdownNumber').offsetWidth; $('countdownNumber').style.animation = 'countPop 0.5s ease-out'; } else { clearInterval(iv); $('countdownScreen').classList.add('hidden'); startGame(); } }, 800);
}

function startGame() {
  state.screen = 'playing'; config = TIERS[state.tier];
  Object.assign(state, { score: 0, streak: 0, bestStreak: 0, hits: 0, misses: 0, totalTargets: 0, timeLeft: 60, running: true, reactionTimes: [] });
  $('tierDisplay').textContent = config.name; $('strobeRate').textContent = config.strobeRate || 'OFF'; updateHUD();
  if (gp.connected) { const area = playArea.getBoundingClientRect(); gp.crossX = area.width / 2; gp.crossY = area.height / 2; updateCrosshairPosition(); }
  gameTimer = setInterval(() => { state.timeLeft--; $('timeDisplay').textContent = state.timeLeft; $('progressFill').style.width = ((60 - state.timeLeft) / 60 * 100) + '%'; if (state.timeLeft <= 0) endGame(); }, 1000);
  if (config.strobeRate > 0) { const ms = 60000 / config.strobeRate; strobeTimer = setInterval(() => { if (!state.running) return; $('strobeOverlay').classList.add('active'); setTimeout(() => $('strobeOverlay').classList.remove('active'), config.strobeDark); }, ms); $('strobeLabel').textContent = 'Strobe Active'; $('strobeDot').style.background = 'var(--gold)'; $('strobeDot').style.animation = 'strobeBlink 1s ease-in-out infinite'; } else { $('strobeLabel').textContent = 'Strobe Off'; $('strobeDot').style.background = 'var(--muted)'; $('strobeDot').style.animation = 'none'; }
  spawnTarget(); spawnTimer = setInterval(() => { if (!state.running) return; if (document.querySelectorAll('.target').length < config.maxTargets) spawnTarget(); }, config.spawnRate);
  playArea.addEventListener('click', onMouseClick);
}

function spawnTarget() {
  if (!state.running) return;
  const isDecoy = config.decoys && Math.random() < 0.25, isBonus = !isDecoy && Math.random() < 0.12;
  const area = playArea.getBoundingClientRect(), m = 40;
  const x = m + Math.random() * (area.width - 56 - m * 2), y = m + Math.random() * (area.height - 56 - m * 2);
  const el = document.createElement('div');
  el.className = `target ${isDecoy ? 'decoy' : ''} ${isBonus ? 'bonus' : ''}`;
  el.dataset.type = isDecoy ? 'decoy' : (isBonus ? 'bonus' : 'normal');
  el.dataset.spawn = Date.now(); el.style.left = x + 'px'; el.style.top = y + 'px';
  el.innerHTML = '<div class="target-ring"><div class="target-core"></div></div>';
  el.addEventListener('click', (e) => { e.stopPropagation(); hitTarget(el); });
  playArea.appendChild(el); state.totalTargets++;
  const life = isBonus ? config.targetLife * 0.7 : config.targetLife;
  setTimeout(() => { if (!el.parentNode) return; if (!isDecoy) { state.misses++; state.streak = 0; updateHUD(); } el.remove(); }, life);
}

function hitTarget(el) {
  if (!state.running) return;
  const type = el.dataset.type, reaction = Date.now() - parseInt(el.dataset.spawn);
  const r = el.getBoundingClientRect(), pr = playArea.getBoundingClientRect();
  const cx = r.left - pr.left + r.width / 2, cy = r.top - pr.top + r.height / 2;
  if (type === 'decoy') { state.score = Math.max(0, state.score - 50); state.streak = 0; showFx(cx, cy, '-50', 'penalty'); }
  else { const base = type === 'bonus' ? 200 : 100; const pts = base + Math.floor(state.streak / 3) * 25 + (reaction < 500 ? 50 : reaction < 800 ? 25 : 0); state.score += pts; state.hits++; state.streak++; state.bestStreak = Math.max(state.bestStreak, state.streak); state.reactionTimes.push(reaction); showFx(cx, cy, '+' + pts, type === 'bonus' ? 'bonus' : 'normal'); }
  el.remove(); updateHUD();
}

function onMouseClick(e) { if (!state.running || e.target.closest('.target')) return; state.misses++; state.streak = 0; updateHUD(); }

function showFx(x, y, text, type) {
  const ring = document.createElement('div'); ring.className = `hit-effect ${type === 'bonus' ? 'bonus' : ''}`; ring.style.left = x + 'px'; ring.style.top = y + 'px'; playArea.appendChild(ring); setTimeout(() => ring.remove(), 500);
  const s = document.createElement('div'); s.className = `hit-score ${type}`; s.textContent = text; s.style.left = x + 'px'; s.style.top = (y - 20) + 'px'; playArea.appendChild(s); setTimeout(() => s.remove(), 800);
}

function updateHUD() { $('scoreDisplay').textContent = state.score; $('streakDisplay').textContent = state.streak; $('missDisplay').textContent = state.misses; const t = state.hits + state.misses; $('accuracyDisplay').textContent = `ACC ${t > 0 ? Math.round((state.hits / t) * 100) : 100}%`; }

function endGame() {
  state.screen = 'results'; state.running = false;
  clearInterval(gameTimer); clearInterval(strobeTimer); clearInterval(spawnTimer);
  $('strobeOverlay').classList.remove('active'); playArea.removeEventListener('click', onMouseClick);
  document.querySelectorAll('.target').forEach(t => t.remove());
  const total = state.hits + state.misses, acc = total > 0 ? Math.round((state.hits / total) * 100) : 0;
  const avgR = state.reactionTimes.length > 0 ? Math.round(state.reactionTimes.reduce((a, b) => a + b, 0) / state.reactionTimes.length) : 0;
  let grade, gc, msg, rankLabel, rankColor;
  if (state.score >= 3000 && acc >= 85) { grade = 'S'; gc = 's-rank'; msg = 'Radiant-level cognitive performance'; rankLabel = 'RADIANT'; rankColor = 'var(--gold)'; }
  else if (state.score >= 2000 && acc >= 75) { grade = 'A'; gc = 'a-rank'; msg = 'Diamond-tier visual processing'; rankLabel = 'DIAMOND'; rankColor = 'var(--teal)'; }
  else if (state.score >= 1200 && acc >= 60) { grade = 'B'; gc = 'b-rank'; msg = 'Gold-level reaction speed'; rankLabel = 'GOLD'; rankColor = 'var(--cyan)'; }
  else { grade = 'C'; gc = 'c-rank'; msg = 'Keep grinding ‚Äî neural pathways adapting'; rankLabel = 'SILVER'; rankColor = 'var(--muted)'; }
  $('resultRankLabel').textContent = rankLabel; $('resultRankLabel').style.color = rankColor;
  $('resultGrade').textContent = grade; $('resultGrade').className = `result-grade ${gc}`;
  $('resultMsg').textContent = msg; $('resultInputTag').textContent = `Played with: ${gp.connected ? 'Controller üéÆ' : 'Mouse üñ±Ô∏è'}`;
  $('resultScore').textContent = state.score; $('resultAccuracy').textContent = acc + '%';
  $('resultStreak').textContent = state.bestStreak; $('resultHits').textContent = state.hits;
  $('resultReaction').textContent = avgR + 'ms'; $('resultTier').textContent = config.short;
  $('resultsScreen').classList.remove('hidden');
  try { fetch('/api/scores', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ game: 'strobe', tier: state.tier, score: state.score, accuracy: acc, bestStreak: state.bestStreak, avgReaction: avgR, hits: state.hits, misses: state.misses, inputMode: gp.connected ? 'controller' : 'mouse', grade: grade }) }).then(function(){}).catch(function(){}); } catch(ignore){}
}

function restartGame() { document.querySelectorAll('.target, .hit-effect, .hit-score').forEach(function(el) { el.remove(); }); $('strobeOverlay').classList.remove('active'); $('resultsScreen').classList.add('hidden'); startCountdown(); }
function backToMenu() { state.screen = 'start'; document.querySelectorAll('.target, .hit-effect, .hit-score').forEach(function(el) { el.remove(); }); $('strobeOverlay').classList.remove('active'); $('resultsScreen').classList.add('hidden'); $('startScreen').classList.remove('hidden'); }
</script>

<script src="/bos-coach-widget.js"></script>
</body>
</html>
